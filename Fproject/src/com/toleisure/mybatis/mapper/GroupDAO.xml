<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.toleisure.mybatis.dao.IGroupDAO">

   <insert parameterType="com.toleisure.mybatis.dto.GroupDTO" id="newGroup">
      {CALL
         DECLARE
            grCodeSeq INT;
         BEGIN
            grCodeSeq := GROUPINGSEQ.NEXTVAL;
            
            <choose>
               <when test='grCate2 != 0'>
                  INSERT INTO TBL_GROUP
                     (GR_CODE, MEM_ID, GR_NAME, GR_PRE, GR_NOTICE, CATE_CODE1, CATE_CODE2)
                  VALUES
                     (grCodeSeq, #{memId}, #{grName}, #{grPre}, #{grNotice}, #{grCate1},#{grCate2});
               </when>
               <otherwise>
                  INSERT INTO TBL_GROUP
                     (GR_CODE, MEM_ID, GR_NAME, GR_PRE, GR_NOTICE, CATE_CODE1)
                   VALUES
                      (grCodeSeq, #{memId}, #{grName}, #{grPre}, #{grNotice}, #{grCate1});
               </otherwise>
            </choose>
            
            INSERT INTO NOW_GROUP
               (NG_CODE
               , GR_CODE
               , NG_PIC
               , NG_MAX
               , NG_MIN,
            NG_STARTDATE, NG_ENDDATE, NG_COST, NG_LOCATION, NG_INTRO, NG_MYINTRO)
            VALUES(NOW_GROUPSEQ.NEXTVAL, grCodeSeq, #{ngPic}, #{ngMax}, #{ngMin}
            , TO_DATE(#{ngStart1}||#{ngStart2}, 'YY-MM-DD HH24:MI:SS'),
            TO_DATE(#{ngEnd1}||#{ngEnd2}, 'YY-MM-DD HH24:MI:SS')
            , #{ngCost}, #{ngLocation1}||#{ngLocation2}
            , #{ngIntro}, #{ngMyIntro});
      END
      }
   </insert>
   
   
      <insert parameterType="com.toleisure.mybatis.dto.GroupDTO" id="addGroup">
      {CALL
         BEGIN

            INSERT INTO TBL_GROUP (GR_CODE, MEM_ID, GR_NAME, GR_PRE, GR_NOTICE, CATE_CODE1)
            VALUES (#{grCode}, #{memId}, #{grName}, #{grPre}, #{grNotice}, #{grCate1});
            
            INSERT INTO NOW_GROUP(NG_CODE
               , GR_CODE
               , NG_PIC
               , NG_MAX
               , NG_MIN,
            NG_STARTDATE, NG_ENDDATE, NG_COST, NG_LOCATION, NG_INTRO, NG_MYINTRO)
            VALUES(NOW_GROUPSEQ.NEXTVAL, #{grCode}, #{ngPic}, #{ngMax}, #{ngMin}
            , TO_DATE(#{ngStart1}||#{ngStart2}, 'YY-MM-DD HH24:MI:SS'),
            TO_DATE(#{ngEnd1}||#{ngEnd2}, 'YY-MM-DD HH24:MI:SS')
            , #{ngCost}, #{ngLocation1}||#{ngLocation2}
            , #{ngIntro}, #{ngMyIntro});
      END
      }
   </insert>
   

	<select id="grSearch" parameterType="com.toleisure.mybatis.dto.MemberDTO" resultType="com.toleisure.mybatis.dto.GroupDTO">
		SELECT G.GR_CODE AS grCode, NG.NG_PIC AS ngPic,  C.CATE_NAME AS grCate1Name, C2.CATE_NAME AS grCate2Name
     		 , G.GR_NAME AS grName, G.GR_PRE AS grPre, G.GR_NOTICE AS grNotice, M.MEM_NAME AS memName, NG.NG_DATE AS ngDate, CNT.GR_COUNT AS grCount
		FROM TBL_GROUP G, NOW_GROUP NG, MEMBER M, CATEGORY C, CATEGORY C2, (SELECT G.GR_CODE AS GR_CODE, COUNT(*) AS GR_COUNT
		                                                                    FROM TBL_GROUP G JOIN NOW_GROUP NG
		                                                                        ON G.GR_CODE=NG.GR_CODE JOIN FIXED_GROUP FG
		                                                                                ON FG.NG_CODE=NG.NG_CODE
		                                                                    GROUP BY G.GR_CODE) CNT
		WHERE G.GR_CODE = NG.GR_CODE AND G.MEM_ID = M.MEM_ID AND G.CATE_CODE1 = C.CATE_CODE AND G.CATE_CODE2 = C2.CATE_CODE(+) 
		  AND CNT.GR_CODE = G.GR_CODE
		  AND (G.GR_CODE, NG.NG_DATE) IN (SELECT G.GR_CODE, MAX(NG_DATE)
		                           FROM NOW_GROUP NG, TBL_GROUP G
		                           WHERE G.GR_CODE=NG.GR_CODE
		                           GROUP BY G.GR_CODE)
		  AND G.MEM_ID= #{memId}
		ORDER BY NG_DATE DESC
	</select>
	
	<select id="groupFormInfo" parameterType="com.toleisure.mybatis.dto.GroupDTO" resultType="com.toleisure.mybatis.dto.GroupDTO">
		SELECT GR_CODE AS grCode, MEM_ID AS memId, GR_NAME AS grName, GR_PRE AS grPre, GR_NOTICE AS grNotice, CATE_CODE1 AS grCode1, CATE_CODE2 AS grCode2
		FROM TBL_GROUP
		WHERE GR_CODE=${grCode}
	</select>
   
   <!-- 
   <select id="grSearch" resultType="com.toleisure.mybatis.dto.GroupDTO">
      SELECT GR_NAME
      FROM NOW_GROUP
      WHERE GR_NAME LIKE %#{검색값}%
   </select>
   
   <select id="grSearch" resultType="com.toleisure.mybatis.dto.GroupDTO">
      SELECT GR_NAME
      FROM NOW_GROUP
      WHERE GR_NAME LIKE %#{검색값}%
   </select>
   
   
   <select id="searchGroup" resultType="com.toleisure.mybatis.dto.GroupDTO">
      SELECT GR_NAME
      FROM NOW_GROUP
      WHERE GR_NAME LIKE %#{검색값}%
   </select>
   
   <select id="searchHost" resultType="com.toleisure.mybatis.dto.GroupDTO">
      SELECT GR_NAME
      FROM NOW_GROUP
      WHERE GR_NAME LIKE %#{검색값}%
   </select>
   
   <select id="searchMood" resultType="com.toleisure.mybatis.dto.GroupDTO">
      SELECT GR_NAME
      FROM NOW_GROUP
      WHERE GR_NAME LIKE %#{검색값}%
   </select>
    -->
   
   

</mapper>